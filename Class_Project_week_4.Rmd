---
title: "Elliott Classs Project"
author: "John Elliott"
date: "August 30, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set working directory and load required libraries
```{r load_packages, echo=TRUE}
        setwd("C:/Users/John/Desktop/R-Code/Coursera/Machine Learning/Class Project")
        library(dplyr, quietly = TRUE,warn.conflicts = FALSE)
        library(ggplot2, quietly = TRUE,warn.conflicts = FALSE)
        library(lubridate, quietly = TRUE,warn.conflicts = FALSE)
        
        library(caret, quietly = TRUE,warn.conflicts = FALSE)
        library(rattle, quietly = TRUE,warn.conflicts = FALSE)
        library(AppliedPredictiveModeling, quietly = TRUE,warn.conflicts = FALSE)
        library(ElemStatLearn, quietly = TRUE,warn.conflicts = FALSE)
        library(pgmm, quietly = TRUE,warn.conflicts = FALSE)
        library(rpart, quietly = TRUE,warn.conflicts = FALSE)
        library(rpart.plot, quietly = TRUE,warn.conflicts = FALSE)
        
```





####Data Download
First a check to see if the required data file is present in the working directory. If it is not found then the file is downloaded and placed into the working directory. 
```{r  download_data, echo=TRUE }
        
        URL <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
        required_training_file <- "pml-training.csv"

        if(!all(lapply(required_training_file,file.exists)==TRUE)){ 
                print("Required Data Files Not Found!")
                print("Please wait while the files are downloaded")
                download.file(URL, destfile = required_training_file, mode="wb")
        }
        
        
        URL <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
        required_testing_file <- "pml-testing.csv"

        if(!all(lapply(required_testing_file,file.exists)==TRUE)){ 
                print("Required Data Files Not Found!")
                print("Please wait while the files are downloaded")
                download.file(URL, destfile = required_testing_file, mode="wb")
        }
        
        
```



#### Load Data Into Envioroment (Reading In Data)
A check for the required data is made and if not found it is read into the environment. 
Also "cache = TRUE" is set for the data chunk to provide data caching.
```{r load_data, echo=TRUE, cache=TRUE  }

        if(!exists("trainingData")){ 
                print("Please Wait while dataset is loaded")
                trainingData <- read.csv(required_training_file, header = TRUE, sep = "," ,dec = ".",na.strings = c("", NA) )
        }


        if(!exists("testingData")){ 
                print("Please Wait while dataset is loaded")
                testingData <- read.csv(required_testing_file, header = TRUE, sep = "," ,dec = ".", na.strings = c("", NA) )
        }



```


####Data Inspection

First we take a quick look at the data set to see what we have.
```{r get_set_size, echo=TRUE}
        set_size <- dim(testingData)
```
- The data set has **`r set_size[1]`** rows and **`r set_size[2]`** columns.

Then we look at a glimpse first few rows and columns of the data set and there structure

```{r get_set_info, echo=TRUE}
        head(testingData[ ,1:15])
        str(testingData[, 1:15])
        colnames(testingData)
        
        head(trainingData[ ,1:15])
        str(trainingData[, 1:15])
        colnames(trainingData)
         
```
 
We check for Na's in the two data sets, remove blank columns from the population and omit first 7 columns of discriptor data.
```{r check_NAs, echo=TRUE}

testingData <- testingData[, colSums(is.na(testingData)) == 0] 
trainingData <- trainingData[, colSums(is.na(trainingData)) == 0] 

checknames <- is.na(match(colnames(trainingData), colnames(testingData)))

trainingData <- trainingData[,7:60]
     testingData <- testingData[,7:60]   
```

We create a validation subset from the training data
```{r validation, echo=TRUE}
     
set.seed(1972) 
inTrain <- createDataPartition(trainingData$classe, p = 0.7, list = FALSE)
trainingData <- trainingData[inTrain, ]
validate <- trainingData[-inTrain, ]

```        
- The  data has: **`r a[3]`** Na's and property damage data has: **`r b[3]`** Na's.

Exploritory plots of the data are created to look for a subset of predictors that may improve the modeling accuracy.

```{r Plot_Data, echo=False}
                                                # one var had seperation
       featurePlot(x = trainingData[, 10:13], 
            y = trainingData$classe,
            plot = "ellipse",
            ## Add a key at the top
            auto.key = list(columns = 3))

 featurePlot(x = trainingData[, 37:41],
            y = trainingData$classe,
            plot = "ellipse",
            ## Add a key at the top
            auto.key = list(columns = 3))


featurePlot(x = trainingData[, 42:45],
            y = trainingData$classe,
            plot = "ellipse",
            ## Add a key at the top
            auto.key = list(columns = 5))


training_set <- colnames(trainingData[c(10:13,37:45)])

transparentTheme(trans = .9)
featurePlot(x = trainingData[, 37:40],
                  y = trainingData$classe,
                  plot = "density",
                  ## Pass in options to xyplot() to 
                  ## make it prettier
                  scales = list(x = list(relation="free"),
                                y = list(relation="free")),
                  adjust = 1.5,
                  pch = "|",
                  layout = c(4, 1),
                  auto.key = list(columns = 5))

gbmImp <- varImp(trainingData, scale = FALSE)

```







 
The full data set is reduced by selecting just the columns required for this report. 
```{r select_data, echo=TRUE  }

set.seed(1972)

mod1 <- train(as.factor(classe) ~ . ,  method = "rpart", data = trainingData)

mod1$finalModel


mod2 <- train(as.factor(classe) ~ accel_belt_y + accel_belt_z + magnet_belt_x + magnet_belt_y +    
accel_dumbbell_z + magnet_dumbbell_x + magnet_dumbbell_y + magnet_dumbbell_z + roll_forearm + pitch_forearm + yaw_forearm + total_accel_forearm + gyros_forearm_x , method = "rpart", data = trainingData)

mod2$finalModel

print(mod1)
print(mod2)

plot(mod2$finalModel, uniform=TRUE, main="Classification Tree")
fancyRpartPlot(fit_rpart$finalModel)
text(mod2$finalModel, use.n = TRUE, all = TRUE, cex = 0.8)

fancyRpartPlot(mod1$finalModel)
fancyRpartPlot(mod2$finalModel)


mod1_prediction <- predict(mod1, validate)
mod2_prediction <- predict(mod2, validate)



mod1_confusion <- confusionMatrix(validate$classe, mod1_prediction)
mod2_confusion <- confusionMatrix(validate$classe, mod2_prediction)


(accuracy_mod1 <- mod1_confusion$overall[1])
(accuracy_mod2 <- mod2_confusion$overall[1])


```

The variable names are given descriptive names 
```{r clean_Names, echo=TRUE }
        

myControl <- trainControl(method = "cv", number = 5)



mod3 <- train(as.factor(classe) ~ .,method="rf",trControl=myControl,data=trainingData)

con_predict <- predict(mod3, validate)
accuracy <- con_predict$overall[1]
(My_Confusion <- confusionMatrix(validate$classe, con_predict))
(accuracy <- My_Confusion$overall[1])




(predict(mod3, testingData))

# [1] B A B A A E D B A A B C B A E E A B B B
#Levels: A B C D E


  
```